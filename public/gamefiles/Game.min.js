var explosions,bullets,fireTrailPool=[],cometTimerInterval=4e3,cometSpeed=50,codeFontSize,codeFontAdjust=0,cometTimer,Game={create:function(){this.initializeLevelVars(),this.game.physics.startSystem(Phaser.Physics.ARCADE),this.background=this.game.add.tileSprite(0,0,this.game.width,this.game.height,"space"),this.background.autoScroll(-20,0),this.city=this.game.add.sprite(0,552,"city"),this.laser=this.game.add.sprite(480,545,"laser"),this.terminal=this.game.add.sprite(175,-50,"terminal"),this.terminal.scale.setTo(.8),this.terminalTween=this.game.add.tween(this.terminal),this.terminalTween.to({x:175,y:10},800),this.terminalTween.start(),this.createHealthUnits(),this.game.physics.enable(this.city,Phaser.Physics.ARCADE),this.city.body.immovable=!0,this.game.score=0,this.game.perfectCounter=0,this.game.multiplier=1,this.game.cityHealth=5,this.currentFireTrail=0,this.musicPlaying=!0,stringIndex=0,codeLineIndex=0,this.explosionSound=this.add.audio("explosion2"),this.laserSound=this.add.audio("laserAudio"),this.multiSound=this.add.audio("multiUp"),5===currentLevel?(this.bossSound=this.add.audio("bossMusic"),this.bossSound.play()):(this.levelMusic=this.add.audio("levelMusic"),this.levelMusic.play()),codeText=this.game.add.text(250,43+codeFontAdjust,levelLines[codeLineIndex],{font:codeFontSize+"px Monospace",fill:"#fff"}),codeText.parent.bringToTop(codeText),gameScoreText=this.game.add.text(30,45,"0",{font:"24px Cousine",fill:"#ff0044",align:"center",fontWeight:"bold"}),multiplierText=this.game.add.text(845,30,"1x",{font:"36px Cousine",fill:"#ff0044",align:"center",fontWeight:"bold"}),streakText=this.game.add.text(890,90,"1",{font:"36px Cousine",fill:"#ff0044",align:"center"}),levelText=this.game.add.text(430,300,"Level "+currentLevel,{font:"36px Cousine",fill:"#ff0044",align:"center"}),this.levelTimer=this.game.time.events.loop(2e3,this.killLevelText,this);var e=this;this.game.input.keyboard.onDownCallback=function(t){stringIndex>codeText.text.length;var i=codeText.text.charAt(stringIndex);keyIndex[i]===t.keyCode&&13!=t.keyCode?(codeText.addColor("#00ff00",stringIndex),stringIndex++,codeText.addColor("#fff",stringIndex)):13===t.keyCode&&codeLineIndex+1===levelLines.length?(this.game.score+=100*this.game.multiplier,5!=currentLevel?e.destroyComet():(e.shootMoth(),e.destroyMoth()),e.world.remove(codeText),e.gameOver("win")):13===t.keyCode&&stringIndex===codeText.text.length?(codeLineIndex++,this.game.score+=100*this.game.multiplier,5!=currentLevel?e.destroyComet():e.shootMoth(),e.world.remove(codeText),codeText=this.game.add.text(250,43+codeFontAdjust,levelLines[codeLineIndex],{font:codeFontSize+"px Monospace",fill:"#fff"}),codeText.parent.bringToTop(codeText),stringIndex=0):16!=t.keyCode&&(e.game.perfectCounter=0)},this.laserKey=this.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),this.laserKey=this.input.keyboard.addKey(Phaser.Keyboard.BACKSPACE),this.comets=this.game.add.group(),this.comets.physicsBodyType=Phaser.Physics.ARCADE,this.comets.enableBody=!0,explosions=this.game.add.group();for(var t=0;10>t;t++){var i=explosions.create(0,0,"explosion",[0],!1);i.anchor.setTo(.5,.5),i.scale.setTo(.7),i.animations.add("explosion")}this.pushToFireTrailPool(10),bullets=this.game.add.group(),bullets.enableBody=!0,bullets.physicsBodyType=Phaser.Physics.ARCADE,bullets.createMultiple(30,"bullet",0,!1),bullets.setAll("anchor.x",.5),bullets.setAll("anchor.y",.5),bullets.setAll("outOfBoundsKill",!0),bullets.setAll("checkWorldBounds",!0),5===currentLevel?(this.brick=this.game.add.sprite(120,520,"brick"),this.brick.scale.setTo(1),this.brick.scale.x*=-1,this.dropMoth()):(this.dropComet(),cometTimer=this.game.time.events.loop(cometTimerInterval,this.dropComet,this),cometTimer.timer.resume())},update:function(){this.game.physics.arcade.collide(this.city,this.comets,this.hitCity,null,this),this.game.physics.arcade.overlap(this.city,this.megaMothra,this.mothHitCity,null,this),5===this.game.perfectCounter?this.game.multiplier=2:10===this.game.perfectCounter?this.game.multiplier=3:15===this.game.perfectCounter?this.game.multiplier=4:20===this.game.perfectCounter?this.game.multiplier=5:0===this.game.perfectCounter&&(this.game.multiplier=1),gameScoreText.setText(this.game.score),multiplierText.setText(this.game.multiplier+"x"),streakText.setText(this.game.perfectCounter),this.terminal.bringToTop(),codeLineIndex+1!=levelLines.length&&codeText.parent.bringToTop(codeText)},initializeLevelVars:function(){1===currentLevel?(levelLines=levelOneLines,cometSpeed=50,cometTimerInterval=4e3,codeFontSize=26,codeFontAdjust=0):2===currentLevel?(levelLines=levelTwoLines,cometSpeed=50,cometTimerInterval=4e3,codeFontSize=24,codeFontAdjust=1):3===currentLevel?(levelLines=levelThreeLines,cometSpeed=50,cometTimerInterval=3900,codeFontSize=24,codeFontAdjust=1):4===currentLevel?(levelLines=levelFourLines,cometSpeed=50,cometTimerInterval=3800,codeFontSize=22,codeFontAdjust=2):5===currentLevel&&(levelLines=levelFiveLines,cometSpeed=50,cometTimerInterval=3200,codeFontSize=20,codeFontAdjust=3)},killLevelText:function(){levelText.destroy()},dropComet:function(){this.comet=this.comets.create(this.game.world.randomX,0,"comet"),this.comet.enableBody=!0,this.comet.scale.setTo(1),this.comet.body.velocity.y=cometSpeed,this.comet.body.collideWorldBounds=!0;var e=fireTrailPool[this.currentFireTrail],t=-1*this.comet.body.velocity.x,i=-1*this.comet.body.velocity.y;e.minParticleSpeed.set(t,i),e.maxParticleSpeed.set(t,i),e.emitX+=13,e.emitY-=5,e.start(!1,3e3,5),this.comet.addChild(e),this.pushToFireTrailPool(1),this.currentFireTrail=Phaser.Math.wrap(this.currentFireTrail+1,0,fireTrailPool.length),this.terminal.bringToTop(),codeText.parent.bringToTop(codeText)},destroyComet:function(){if(-1!=this.comets.getAt(0)){this.explosionSound.play();var e=explosions.getFirstExists(!1);e.reset(this.comets.getAt(0).body.x+18,this.comets.getAt(0).body.y+15),e.play("explosion",30,!1,!0),this.fireBullet(this.comets.getAt(0),6),this.comets.getAt(0).destroy(),this.game.perfectCounter+=1,this.game.perfectCounter%5===0&&this.multiSound.play()}},dropMoth:function(){this.megaMothra=this.game.add.sprite(0,0,"megamothAni"),this.game.physics.enable(this.megaMothra,Phaser.Physics.ARCADE),this.megaMothra.scale.setTo(.4),this.megaMothra.enableBody=!0,this.megaMothra.animations.add("fly",null,10,!0),this.megaMothra.animations.play("fly"),this.megaMothraXindex=this.megaMothra.x,this.megaMothraYindex=this.megaMothra.y,this.flyRight=!0,this.flyMoth(),mothTimer=this.game.time.events.loop(25500,this.flyMoth,this)},flyMoth:function(){this.flyRight===!0?(this.megaMothraXindex+=730,this.megaMothraYindex+=50,this.mothFlyTween=this.game.add.tween(this.megaMothra),this.mothFlyTween.to({x:this.megaMothraXindex,y:this.megaMothraYindex},25e3).start(),this.flyRight=!1):(this.megaMothraXindex-=730,this.megaMothraYindex+=50,this.mothFlyTween=this.game.add.tween(this.megaMothra),this.mothFlyTween.to({x:this.megaMothraXindex,y:this.megaMothraYindex},25e3).start(),this.flyRight=!0)},shootMoth:function(){this.fireBullet(this.megaMothra,15),codeLineIndex===levelLines.length&&this.megaMothra.destroy(),this.game.perfectCounter+=1,this.game.perfectCounter%5===0&&this.multiSound.play()},destroyMoth:function(){this.explosionSound.play();var e=explosions.getFirstExists(!1);e.reset(this.megaMothra.body.x+80,this.megaMothra.body.y+50),e.play("explosion",30,!1,!0),this.megaMothra.destroy()},postScore:function(){console.log("posting score"),$.ajax({type:"POST",url:"users/"+user_id+"/scores",data:{score:this.game.score,name:"Codefall",level:currentLevel}}).success(function(e){console.log("worked"+e)}).fail(function(){console.log("failed")})},fireBullet:function(e,t){this.laserSound.play();var i=bullets.getFirstExists(!1);i.reset(this.laser.x+26,this.laser.y+20),i.body.velocity.y=(e.y-this.laser.y)*t,i.body.velocity.x=(e.x-this.laser.x)*t,i.rotation=Phaser.Math.angleBetween(this.laser.x,this.laser.y,e.x,e.y)+90*(Math.PI/180)},gameOver:function(e){5!=currentLevel&&cometTimer.timer.pause(),void 0!=user_id&&this.postScore(),this.retryButton=this.game.add.sprite(220,290,"blueButton"),this.mainMenuButton=this.game.add.sprite(545,290,"blueButton"),retryText=this.game.add.text(300,315,"Retry",{font:"24px Cousine",fill:"white",align:"center"}),mainMenuText=this.game.add.text(600,315,"Main Menu",{font:"24px Cousine",fill:"white",align:"center"}),"win"===e?winText=this.game.add.text(440,200,"YOU WIN!",{font:"24px Cousine",fill:"white",align:"center"}):gameOverText=this.game.add.text(440,200,"Game Over",{font:"24px Cousine",fill:"white",align:"center"}),this.mainMenuButton.inputEnabled=!0,this.retryButton.inputEnabled=!0,this.mainMenuButton.events.onInputDown.add(this.mainMenuNav,this),this.retryButton.events.onInputDown.add(this.restartGame,this)},mainMenuNav:function(){5!=currentLevel?(console.log("music paused"),this.levelMusic.pause()):5===currentLevel&&(console.log("music paused"),this.bossSound.pause()),fireTrailPool=[],this.game.state.start("MainMenu")},restartGame:function(){fireTrailPool=[],this.game.state.start("Game")},hitCity:function(){this.explosionSound.play();var e=explosions.getFirstExists(!1);e.reset(this.comets.getAt(0).body.x+11,this.comets.getAt(0).body.y+4),e.play("explosion",30,!1,!0),this.comets.getAt(0).destroy(),this.game.cityHealth-=1,this.game.perfectCounter=0,4===this.game.cityHealth?this.healthUnit5.kill():3===this.game.cityHealth?this.healthUnit4.kill():2===this.game.cityHealth?this.healthUnit3.kill():1===this.game.cityHealth?this.healthUnit2.kill():0===this.game.cityHealth&&(this.healthUnit1.kill(),this.gameOver())},mothHitCity:function(){console.log("moth hit city"),this.explosionSound.play();var e=explosions.getFirstExists(!1);e.reset(this.megaMothra.body.x+80,this.megaMothra.body.y+50),e.play("explosion",30,!1,!0),this.megaMothra.destroy(),this.game.cityHealth-=1,this.healthUnit1.kill(),this.gameOver()},pushToFireTrailPool:function(e){for(var t=0;e>t;t++){var i=this.game.add.emitter(0,0,400);i.makeParticles(["fire1","fire2","fire3","smoke"]),i.gravity=8,i.setAlpha(1,0,3e3),i.setScale(.28,.45,.28,.45,3e3),fireTrailPool.push(i)}},createHealthUnits:function(){this.steakCard=this.game.add.sprite(790,10,"streakCard"),this.scoreCard=this.game.add.sprite(15,10,"scoreCard"),this.menuButton=this.game.add.sprite(15,88,"menuButton"),this.menuButton.inputEnabled=!0,this.menuButton.events.onInputDown.add(this.mainMenuNav,this),mainMenuText=this.game.add.text(27,107,"Main Menu",{font:"24px Cousine",fill:"black",align:"center",fontWeight:"bold"}),this.muteButton=this.game.add.sprite(15,154,"menuButton"),this.muteButton.scale.setTo(.4),this.muteButton.inputEnabled=!0,this.muteButton.events.onInputDown.add(this.toggleMusic,this),muteText=this.game.add.text(26,158,"Mute",{font:"16px Cousine",fill:"black",align:"center",fontWeight:"bold"}),this.healthUnits=this.game.add.group(),this.healthBar=this.game.add.sprite(725,500,"healthBar"),this.healthBar.scale.setTo(.4),this.healthEmptyUnit1=this.healthUnits.create(738,505,"healthUnitWire"),this.healthEmptyUnit2=this.healthUnits.create(778,505,"healthUnitWire"),this.healthEmptyUnit3=this.healthUnits.create(818,505,"healthUnitWire"),this.healthEmptyUnit4=this.healthUnits.create(858,505,"healthUnitWire"),this.healthEmptyUnit5=this.healthUnits.create(898,505,"healthUnitWire"),this.healthUnit1=this.healthUnits.create(738,505,"healthUnit"),this.healthUnit1.scale.setTo(.4),this.healthEmptyUnit1.scale.setTo(.4),this.healthEmptyUnit2.scale.setTo(.4),this.healthEmptyUnit3.scale.setTo(.4),this.healthEmptyUnit4.scale.setTo(.4),this.healthEmptyUnit5.scale.setTo(.4),5!=currentLevel&&(this.healthUnit2=this.healthUnits.create(778,505,"healthUnit"),this.healthUnit3=this.healthUnits.create(818,505,"healthUnit"),this.healthUnit4=this.healthUnits.create(858,505,"healthUnit"),this.healthUnit5=this.healthUnits.create(898,505,"healthUnit"),this.healthUnit2.scale.setTo(.4),this.healthUnit3.scale.setTo(.4),this.healthUnit4.scale.setTo(.4),this.healthUnit5.scale.setTo(.4))},toggleMusic:function(){this.musicPlaying===!0&&5===currentLevel?(console.log("music paused"),this.bossSound.pause(),this.musicPlaying=!1):this.musicPlaying===!1&&5===currentLevel?(console.log("music resume"),this.bossSound.resume(),this.musicPlaying=!0):this.musicPlaying===!0&&5!=currentLevel?(console.log("music paused"),this.levelMusic.pause(),this.musicPlaying=!1):this.musicPlaying===!1&&5!=currentLevel&&(console.log("music resume"),this.levelMusic.resume(),this.musicPlaying=!0)},cityFire:function(){console.log("fire in the city!");var e=fireTrailPool[this.currentFireTrail],t=-1*this.comet.body.velocity.x,i=-1*this.comet.body.velocity.y;e.minParticleSpeed.set(t,i),e.maxParticleSpeed.set(t,i),e.x=400,e.y=400,e.setScale(.2,.45,.2,.45,3e3),e.start(!1,3e3,5),this.comet.addChild(e),this.pushToFireTrailPool(1),this.currentFireTrail=Phaser.Math.wrap(this.currentFireTrail+1,0,fireTrailPool.length)}};
